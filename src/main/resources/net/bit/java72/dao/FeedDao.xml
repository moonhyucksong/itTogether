<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.bit.java72.dao.FeedDao">
  <resultMap  type="Feed"        id="FeedMap">
    <id     column="fno"         property="fno" />
    <result column="categry"     property="category" />
    <result column="contnt"      property="content" />
    <result column="cre_dt"      property="createDate" />
    <result column="max_headcnt" property="maxHeadCount"/>
    <result column="current_cnt" property="currentCount"/>
    <result column="meet_time"   property="meetTime"/>
    <result column="attachFile1" property="attachFile1"/>
    <result column="attachFile2" property="attachFile2"/>
    <result column="attachFile3" property="attachFile3"/>
  </resultMap>
  
  <resultMap  type="FriendFeed"  id="FriendFeedMap">
    <id     column="fno"         property="fno" />
    <result column="categry"     property="category" />
    <result column="contnt"      property="content" />
    <result column="cre_dt"      property="createDate" />
    <result column="max_headcnt" property="maxHeadCount"/>
    <result column="current_cnt" property="currentCount"/>
    <result column="meet_time" property="meetTime"/>
    <result column="attachFile1" property="attachFile1"/>
    <result column="attachFile2" property="attachFile2"/>
    <result column="attachFile3" property="attachFile3"/>
    <result column="nicknm"    property="nickname" />
    <result column="pwd"      property="password" />
    <result column="hometwn" property="hometown"/>
    <result column="lat" property="latitude"/>
    <result column="lon" property="longitude"/>
    <result column="addr" property="address"/>
    <result column="mphoto" property="profilePicture"/>
  </resultMap>
 
  <resultMap type="FriendList" id="FriendListMap">
  <id     column="fno"      property="fno" />
  <id     column="mno"      property="mno" />
  </resultMap>
  
  <resultMap type="Comment" id="CommentMap">
     <id       column="fno"        property="fno"/>
     <id         column="mno"        property="mno"/>
     <id       column="cno"        property="cno"/>
     <result     column="contnt"     property="content"/>
     <result     column="pwd"        property="password"/>
     <result     column="nicknm"     property="nickname" />
     <result   column="mphoto"     property="profilePicture"/>
  </resultMap>
 <!--  모임약속시간 이 현재시간보다 나중이어야 출력하는걸로 수정 -->
  <select id="list" resultMap="FriendFeedMap" parameterType="int">
  select 
   t1.nicknm,
   t1.NAME,
   t1.MPHOTO,
   t2.FNO,
   t2.CATEGRY,
   t2.MAX_HEADCNT,
   t2.CURRENT_CNT,
   t2.MEET_TIME,
   t2.CONTNT,
   t2.cre_dt,
   t2.TITLE,
   t2.attachFile1,
   t2.attachFile2,
   t2.attachFile3
   from MEMB_T t1 left outer join FEED_T t2 
   on t1.mno=t2.mno
   where t2.categry is not null and t2.meet_time > now() and t1.mno IN (select frdno from FRD_T where mno=#{values} and state=2)
   ORDER by t2.cre_dt desc;
  </select> 
  
  <select id="listFrd" resultMap="FriendFeedMap" parameterType="int">
  select
  t1.mno,
  t1.MPHOTO,
  t2.mno,
  t2.fno
  from MEMB_T t1 inner join JOINEDFRD_T t2 
   on t2.fno= #{value} and t1.mno = t2.mno
  </select>
  
  <!--  모임약속시간 이 현재시간보다 나중이어야 출력하는걸로 수정 -->
  <select id="noneFriendFeed" resultMap="FriendFeedMap" parameterType="int">
  select 
   t1.nicknm,
   t1.NAME, 
   t1.MPHOTO,
   t2.fno,
   t2.CATEGRY,
   t2.MAX_HEADCNT,
   t2.CURRENT_CNT,
   t2.MEET_TIME,
   t2.CONTNT,
   t2.cre_dt,
   t2.TITLE,
  t2.attachFile1,
  t2.attachFile2,
  t2.attachFile3
   from MEMB_T t1 left outer join FEED_T t2
   on t1.mno=t2.mno
   where t2.categry is not null and t1.mno=#{values} and t2.meet_time > now()
  </select>
  
  <select id="nlistFrd" resultMap="FriendFeedMap" parameterType="int">
  select
  t1.mno,
  t1.MPHOTO,
  t2.mno,
  t2.fno
  from MEMB_T t1 inner join FOINEDFRD_T t2 
   on t2.fno= #{value} and t1.mno = t2.mno
  </select>
  
  <insert id="insert" parameterType="Feed">
  INSERT INTO 
  FEED_T(mno,categry,contnt,cre_dt,title,max_headcnt,meet_time,attachFile1,attachFile2,attachFile3)
  VALUES (#{mno},#{category},#{content},now(),#{title},#{maxHeadCount},#{meetTime},#{attachFile1},#{attachFile2},#{attachFile3})
  </insert>
  
 <!-- 내정보 에서 밑에 게시물 출력 -->
   <select id="myActivityList" resultMap="FriendFeedMap">
  select 
  t1.mno,
  t1.nicknm,
  t1.name,
  t1.MPHOTO,
  t2.FNO,
  t2.CATEGRY,
  t2.MAX_HEADCNT,
  t2.CURRENT_CNT,
  t2.MEET_TIME,
  t2.CONTNT,
  t2.cre_dt,
  t2.TITLE,
  t2.attachFile1,
  t2.attachFile2,
  t2.attachFile3
  from MEMB_T t1 inner join FEED_T t2 on t1.mno=t2.mno
  where t2.mno = #{values}  
  or t2.fno IN (select t3.fno from JOINEDFRD_T t3 inner join feed_t t4 on t3.fno=t4.fno where t3.mno=#{values}) 
  ORDER by t2.cre_dt desc
  </select>
 
  <select id="myActivityListFrd" resultMap="FriendFeedMap" parameterType="int">
  select
  t1.mno,
  t1.MPHOTO,
  t2.mno,
  t2.fno
  from MEMB_T t1 inner join JOINEDFRD_T t2 
   on t2.fno= #{value} and t1.mno = t2.mno
  </select>
 
 <select id="getDetail" resultMap="FriendFeedMap" parameterType="int">
  select 
   t1.nicknm,
   t1.name,
   t1.MPHOTO,
   t2.FNO,
   t2.CATEGRY,
   t2.MAX_HEADCNT,
   t2.CURRENT_CNT,
   t2.MEET_TIME,
   t2.CONTNT,
   t2.cre_dt,
   t2.TITLE,
   t2.attachFile1,
   t2.attachFile2,
   t2.attachFile3
   from MEMB_T t1 inner join FEED_T t2 
   on t2.fno= #{value} and t1.mno = t2.mno
  </select>
  
   <insert id="friendJoinActivity" parameterType="map">
      insert into JOINEDFRD_T(mno, fno) values(#{mno}, #{fno})
  </insert>
  
   <delete id="friendOutActivity" parameterType="map">
      delete from JOINEDFRD_T where fno=#{fno} and mno=#{mno}
   </delete>

   <update id="friendIn" parameterType="int">
     update FEED_T set current_cnt=current_cnt+1 where fno=#{fno}
   </update>
   
   <update id="friendOut" parameterType="int">
     update FEED_T set current_cnt=current_cnt-1 where fno=#{fno}
   </update>
    

  <select id="checkFeed" parameterType="map" resultMap="FeedMap">
    select *
    FROM JOINEDFRD_T where fno=#{fno} and mno=#{mno}
  </select>
  
  <select id="getComment" parameterType="int" resultMap="CommentMap">
   select
    t1.mno,
    t1.nicknm,
    t1.name,
    t1.mphoto,
    t2.fno,
    t2.cno,
    t2.contnt
   from MEMB_T t1 inner join COMMENT_T t2
   on t1.mno = t2.mno where fno = #{values} 
  </select>
  
  <insert id="insertComment" parameterType="Comment">
  insert into COMMENT_T(fno, mno, contnt, cre_dt) values(#{fno},#{mno},#{content},now())  
  </insert>
  
  <update id="updateComment" parameterType="Comment">
  update COMMENT_T set contnt=#{content} where cno=#{cno}
  </update>
  
  <delete id='deleteComment' parameterType='int'>
  delete from COMMENT_T where cno=#{values}
  </delete>
  
  <select id="commentPhotolist" resultMap="FriendFeedMap" parameterType="int">
  select * from memb_t where mno IN (select mno from joinedfrd_t where fno=#{value});
  </select>
</mapper>